# Building a full version of QNial7 

This directory is used to build a full executable version of QNial7 that
extends the core to hold the features described in a package descriptor 
file. The directory BuildNial has the following structure:


Entry          | Contents                                   
-------------- | ---------------------------------------- 
README.md      | The file you are currently reading 
build          | directory used by CMake, initially empty
pkgblder       | The directory used to select a package and add features
src            | filled by pkgblder with source code  and CmakeLists.txt, initially empty
testing        | directories for testing QNial7 versions
tools          | software tools

QNial7 can be built for Linux, OSX, Raspbian (RaspberryPI) and Windows (both Cygwin and Native versions).

The process of building the native Windows version is described separately from the other builds which are all based on UNIX.

# Building the Linux, OSX, Raspbian and Cygwin Versions

These versions are described together as they essentially involve the same set of
commands. 

## Requirements

The build process uses CMake and requires that you have installed this. You can
use either the command line version of CMake or the GUI.

Both the CLANG compiler and GCC can be used to build Nial so that you will need
to have installed one of these compilers. On OSX you should install *XCode*,
on Linux use the appropriate package manager for your distribution. CLANG appears
to generate slightly faster code on Linux.

For the following sections we assume that you are building with gcc. 

If you are cross compiling the Windows version then you will need to have installed 
the Mingw-w64 tools. This is best done using the package manager on your Linux system.
A CMake Toolchain file is provided in the tools subdirectory and its use is noted
in the following lines. It only needs to be used in the final build stage when you
are adding feaures and building a Windows version.

# Building a QNial7 version using pkgblder

A QNial7 exeutable includes the core functionality built using BuildCore, the
extensions that add the functionality described in the document 
*../doc/V7 Nial Extensions.pdf*,
and additional features of interest to some users. 

A QNial7 package builds an executable that consists of the core and and the 
set of features described in its <package>.txt file. The work to assemble
the src for the package and a corresponding *CMakeLists.txt* file is done in 
the directory "pkgblder".

The directory pkgblder has the following structure:

Entry             | Contents                                   
---------------   | ---------------------------------------- 
addfeatures.ndf   | Nial script that generates the ../src directory
allfeatures       | directory of subdirectories for each feature       
buildfromcore.ndf | Nial script that builds a basic version from the core
Cmake*            | three files used to generate CmakeLists.txt
coreprims.nh      | descriptor file for the core primitives
corenial          | core version of generated by Buildcore 
nial_basic        | basic version generated using package "basic_nial.txt"
nial              | standard version of generated using package "qnial7.txt"
nialcoredefs.ndf  | Nial definitions written added for all versions.
packages          | directory of package files
src_nialcore      | src files copied to the ../src directory



The directory BuildNial is used to build either a basic version of Nial that 
adds just a set of definitions written in Nial to the initial workspace or 
to build a Nial version that includes a number of features that have been 
added in QNial7. There are also some optional features that may
be added if desired.

The basic version is built first with the following steps:

1. Change to  BuildNial directory:
	
   $ cd BuildNial

2. Clear the build and src subdirectories:

   $ rm -r build/*
   
   $ rm -r src/*

3. Change to the directory pkgblder to build the basic version:

   $ cd pkgblder

4. Run the Nial script *buildfromcore.ndf* to populate the src directory with the
   source code and *CMakeLists.txt* files:
   
   $ ./nialcore -defs buildfromcore

5. Nial can be
   built either as a 32 bit system or as a 64 bit system. This is controlled
   by options set in the *CMakeLists.txt* file in the source directory. You
   can also set a fast math option which sets the compiler flags appropriately.

6. If you are using the Cmake GUI then run it now with the source directory 
   set to *BuildNial/src* and the build directory to *BuildNial/build*. Then
   change to the build directory.

   If you are using the command line version of Cmake then do the following:

   $ cd build
   
   $ cmake ../src
 
6. Do the make in the build directory to build executable nial:

   $ cd ../build
   
   $ make

7. Test the nial executable in build by running it interactively using

   $ ./nial -i

   This will display a header and a prompt of 5 spaces.
   Enter the nial expression: 
   
   *5 + count 10*

   It displays the result:

   *6 7 8 9 10 11 12 13 14 15*
   

   This example shows that the definition of *count* as

       *count IS OPERATION A { 1 + tell A }*

   has been installed correctly.

8. Move the nial executable into the pkgblder directory and rename it nial_basic:

   $ mv nial ../pkgblder/nial_basic

We have now completed the process of getting a nial executable that can be used
to add other features. 

# Creating Nial Packages

We define a "Nial package" as  basic nial extended by selected features.
The design of pkgblder is intended to be open ended so that new features can 
be developed and easily included in packages.

Each package file is described by a text file named <pkgname>.txt.

The first line of the file is a title for the package. It does not need
to be the same as the package name. The remaining lines provide the names of the 
features to be included from the list below. A line begining with # or that is
empty is ignored.

Each feature is given a name in all capitals thst is the name of its subdirectory.
The current set of features are:

Feature       | Capability
------------- | ------------------------ 
DEBUGINCLUDED |	adds DEBUG capability to basic nial
MEMSPACES     | supports shared memory spaces  (Linux/OSX)
NCOMPLEX      | complex arithmetic package
NDYNLOAD      | supports dynamic loading in Linux and OSXNFILES        | simple file features
NIALDSP       | digital signal processing support
NIAL_FFTW     | fast fourier transform support
NSFML_AUDIO   | Audio support
NTABLES       | user hash tables for associative array features
PROCESS       | Unix style process control (Linux/OSX)
SOCKETS       | Unix/Windows socket support
QSORT         | Quicksort algorithm	
REGEXP        | Posix regular expression support (Linux/OSX)
SPROCESS      | support for streams (Linux/OSX)
WINPROCESS    | process support for Windows (Windows)

The subdirectory for a feature has one or more files and a subdirectory of src files. For example, the REGEXP directory has:

  File name| Purpose
---------- | -------
REGEXP_src | the source directory
regexp.nh  | the descriptor file for primitives added with the feature
regexp.ndf | its definition to be installed at startup

The feature directory may also have a file with the name in lower case 
followed by _cmake for lines that need to be added to the CmakeLists.txt file 
for the feature.

The available packages are:

File name          |Package description
--------           |  --------
basic_nial.txt     | builds basic_nial
basic_debug.txt    | builds a basic nial with optional DEBUG for testing
QNial7.txt         | builds the standard V7 nial for UNIX systems
AllFeatures.txt    | builds all the features that are not commented out using #.
WinAllFeaures.txt  | builds a Windows version with all applicable features
WinQNial7.txt      | builds the standard V7 nial for Windows systems


# Building a specific Package

1. Change to  BuildNial directory:	
   $ cd BuildNial

2. Clear the build and src subdirectories:

   $ rm -r build/*
   
   $ rm -r src/*

3. Change to the directory pkgblder: 

   $ cd pkgblder

4. Run the Nial script addfeatures.ndf to populate the src directory
   with the source code and CmakeLists.txt file:
   
   $ ./nial_basic -defs addfeatures

   This will present a list of packages numbered from 0. Respond with the number of the package you wish to create.

5. If you are using the CMake GUI then Run CMake pointing at the BuildNial 
   src and build directories. If you are building a Windows version then
   you will need to set the CMAKE_TOOLCHAIN_FILE variable to the 
   toolchain file found in the 'tools/CmakeTools' directory.
   
   If you are using the command line then do the following:
   
   $cd build
   
   $cmake ../src
   
   or for thw Windows version do:
   
   $cd build
   
   $cmake -DCMAKE_TOOLCHAIN_FILE=../tools/CmakeTools/Toolchain-mingw64-Win64.cmake ../src
 

6. Do the make in the build directory to build executable "nial":

   $ cd ../build
   
   $ make

7. Test the nial executable in build using

   $ ./nial -i

   Try using one of the new primitives added by the package. For example if the
   feature QSORT is included in the package, test that qsort works as expected
   by entering the nial expression:
   
        qsort random 5
        
   0.119586 0.639681 0.72909 0.810901 0.882235

   The result is a set of random numbers between 0. and 1. sorted in ascending
   order. Enter

         bye

   to exit *nial*.

8. You have now completed the process of building an executable *nial* that 
   supports the features selected by the package. To make it the active
   executable *nial*, copy it to a directory that is on your $PATH list. For example if the directory 
   
   /usr/local/bin 
   
   is on your path then copy it there using
   
   $cp nial /usr/local/bin




# Building the Native Windows Version 

The native Windows version can be built either as a cross compilation on Linux or
on a Windows System.

We strongly suggest that you use the Cygwin version, described above, unless you have
a specific need to extend QNial7 with specialised native libraries. The UNIX version
of QNial7, which Cygwin builds, is more advanced in development than the Windows
version.

To date we have only built the Native version using the MinGW version of 
GCC (on Linux or Windows). 

## Cross Compilation

For cross compilation on Linux the *MinGW* cross compiler suite needs to be 
installed on your system and this is best done using your systems package manager.
The build process is then identical to the Linux build with the exception that
*cmake* requires a toolchain file to be specified to indicate the compiler and linker
being used. This toolchain file is provided in the *tools/CmakeTools* sub-directory
of *BuildNial*.

The toolchain is then specified using 

    $ cmake -DCMAKE_TOOLCHAIN_FILE=../tools/CmakeTools/Toolchain* .....

The steps of the build process are then identical to the UNIX builds.

## Building on Windows

Building the native version on Windows is slighty more complicated and requires 
a Cygwin installation, a version of CMake and a version of the MinGW tools (we
currently use the TDM-GCC version). 

Cygwin is needed as the package configuration process was designed to run on 
UNIX systems and executes some Unix utilities (*cp* and *ls*) whose Windows
implementations can be found in the Cygwin distribution. Unless these are 
present on your path the configuration programs will not run.

With the following changes the build process is then similar to the build for 
Linux (i.e. go through the stages specified in BuildCore and BuildNial)

1.  Add the Cygwin binaries to the end of your current path to avoid conflict 
    between Cygwin programs and others that you might have on your path.

    set Path=%Path%;C:\cygwin\bin
    
    The installations of CMake and MinGW will usually add their binaries to 
    your path. You can however check by issuing
    
    path
    
    to explicitly see what your path includes.

2.  Filenames use the Windows conventions for pathnames and programs. For example
    
       copy nialcore.exe ..\\..\\BuildNial\pkgblder\
       
3.  References to *cmake* add an additional parameter and take the form

    cmake -G "MinGW Makefiles" ......
    
    to indicate that CMake should generate Makefiles that are compatible with MinGW.
    
3.  Calls to *make* are replaced by

    mingw32-make
    
    to use the correct version of *make*.




# Adding new features


The pkgblder directory and the addfeatures.ndf Nial script have been designed
to make it straightforward to add new features to QNial7. The term feature
is used in this context to describe an extension to the Nial interpreter
that involves the addition of one or more new primitive functions each of
which may be a basic expression, a basic operation, or a basic  transformer.

The new primitives are implemented in C following the instruction give in 
Chapter 11 of the *Design of QNial V7* document provided in QNial7/docs. 

The
implementation may involve one or more C source files and any corresponding
header files they require. A feature may also add additional functionality
in the form of Nial definitions that are installed at startup of the 
executable. 

Consider a new feature that we will call NEWFEATURE. We create a new directory
in 

QNial7/BuildNial/pkgblder/all_features 

with this name in capital letters. Within
this new directory we create a subdirectory NEWFEATURE_src. 
These steps are done with:

   $ cd all_features
   
   $ mkdir NEWFEATURE
   
   $ cd NEWFEATURE
   
   $ mkdir NEWFEATURE_src


Let us assume that the implementation of the two source files nf1.c and nf2.c
and a header file nf.h. These would be placed in NEWFEATURE_src. 

If there is 
a file of Nial definitions for the new feature then it must be named 
newfeature.ndf and placed in the NEWFEATURE directory.

In order for the interpreter to execute the new primitive functions a 
primitive descriptor file named newfeature.nh is created.  Each line of
the descriptor file describes one primitive function using the following form:

   NEWFEATURE Property Nialname Cname

where:
   Property is a single letter:
   
   U - a unary operation
      
   E - an expression
      
   T - a transformer
      
   Nialname is the name used for the primitive function in Nial
   
   Cname is the name of the C routine that implements the primitive function.

The newfeature.nh file is placed in the NEWFEATURE directory.

In some cases the new functionality being introduced will depend on support
libraries provide by the platform. The Cmake capability has to be provided
with the name of such libraries for the platforms that support the new  feature. 

If this is the create a file:

newfeature_cmake 

that contains
the lines that provide access to the library for the platforms being
supported. An example of such a file is found in the directory for the
feature that supports Fast Fourier transform capabilities, NIAL_FFTW. The file

 nial\_fftw\_cmake  
 
contains the following lines:

```
if (${CMAKE_SYSTEM_NAME} MATCHES "Linux")
  set(NIAL_LIBS ${NIAL_LIBS} fftw3)
endif (${CMAKE_SYSTEM_NAME} MATCHES "Linux")

if (CMAKE_SYSTEM_NAME MATCHES "CYGWIN")
  set(NIAL_LIBS ${NIAL_LIBS} fftw3)
endif (CMAKE_SYSTEM_NAME MATCHES "CYGWIN")

if (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")
  set(NIAL_LIBS ${NIAL_LIBS} fftw3)
endif (${CMAKE_SYSTEM_NAME} MATCHES "Darwin")

if (${CMAKE_SYSTEM_NAME} MATCHES "Windows")
  set(NIAL_LIBS ${NIAL_LIBS} fftw3-3)
endif (${CMAKE_SYSTEM_NAME} MATCHES "Windows")
```

If needed, create a similar file named newfeature_cmake in the NEWFEATURE directory to supply the required support libraries.

When all these files have been set up, create a package file that includes an
entry for NEWFEATURE and build this package as described above.
